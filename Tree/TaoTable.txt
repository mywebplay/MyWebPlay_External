<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
  }
  #searchBox {
    width: 100%;
    padding: 8px;
    margin-bottom: 12px;
    box-sizing: border-box;
    font-size: 16px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
  }
  th, td {
    border: 1px solid #aaa;
    padding: 6px 8px;
    word-wrap: break-word;
    white-space: normal;
    text-align: left;
  }
  th.stt, td.stt {
    width: 5%;
    text-align: center;
  }
</style>
</head>
<body>

<input type="text" id="searchBox" placeholder="Tìm kiếm" />

<table id="dataTable"></table>

<script>
  // Lấy dữ liệu localStorage và xoá vĩnh viễn
  let rawData = localStorage.getItem("tableX") || "";
  localStorage.removeItem("tableX");

  function parseRawData(raw) {
    if (!raw) return { headers: [], data: [] };
    let lines = raw.trim().split(/\r?\n/);
    if (lines.length === 0) return { headers: [], data: [] };

    // Header parse: tách tên và width theo *** và \t
    const headers = lines[0].split('\t').map(h => {
      const parts = h.split('***');
      return {
        name: parts[0].trim(),
        width: parseInt(parts[1]) || 10
      };
    });

    // Data rows
    const data = lines.slice(1).map(line => line.split('\t'));
    return { headers, data };
  }

  function renderTable(dataObj, filterRegex) {
    const { headers, data } = dataObj;
    const table = document.getElementById('dataTable');
    table.innerHTML = '';

    if (headers.length === 0) return;

    // Tạo thead
    const thead = table.createTHead();
    const trHead = thead.insertRow();
    // Cột STT
    let thSTT = document.createElement('th');
    thSTT.textContent = "STT";
    thSTT.className = 'stt';
    trHead.appendChild(thSTT);

    // Header columns theo % width
    headers.forEach(h => {
      const th = document.createElement('th');
      th.textContent = h.name;
      th.style.width = h.width + '%';
      trHead.appendChild(th);
    });

    // Tạo tbody
    const tbody = table.createTBody();
    let sttCount = 1;

    data.forEach(row => {
      // Nếu có filter, kiểm tra tất cả cột (trừ STT)
      if (filterRegex) {
        let matched = row.some(cell => filterRegex.test(cell));
        if (!matched) return; // Bỏ qua dòng này
      }

      const tr = tbody.insertRow();
      // STT
      const tdSTT = tr.insertCell();
      tdSTT.textContent = sttCount++;
      tdSTT.className = 'stt';

      // Các cột dữ liệu
      headers.forEach((_, i) => {
        const td = tr.insertCell();
        td.textContent = row[i] || "";
      });
    });
  }

  // Hàm tạo regex an toàn
  function createSafeRegex(str) {
    try {
      return new RegExp(str, 'i');
    } catch {
      // Nếu regex không hợp lệ thì trả về regex không khớp gì
      return /$^/;
    }
  }

  // Hàm xử lý tìm kiếm
  function handleSearch() {
    const searchVal = document.getElementById('searchBox').value.trim();
    let regex = null;
    if (searchVal.length > 0) {
      regex = createSafeRegex(searchVal);
    }
    renderTable(parsedData, regex);
  }

  // Phân tích dữ liệu
  const parsedData = parseRawData(rawData);

  // Hiển thị bảng lần đầu (không lọc)
  renderTable(parsedData);

  // Gán sự kiện tìm kiếm
  document.getElementById('searchBox').addEventListener('input', handleSearch);
</script>
