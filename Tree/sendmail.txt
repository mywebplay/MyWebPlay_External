<style>
.processing-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(3px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;

    opacity: 0;
    visibility: hidden;
    transition: opacity 0.25s ease, visibility 0.25s ease;
}

/* Khi show */
.processing-overlay.active {
    opacity: 1;
    visibility: visible;
}

.processing-modal {
    width: 320px;
    background: #fff;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    text-align: center;
    transform: scale(0.95);
    transition: transform 0.25s ease;
}

.processing-overlay.active .processing-modal {
    transform: scale(1);
}

.processing-title {
    color: red;
    font-weight: bold;
    font-size: 18px;
    margin-bottom: 20px;
}

.progress-container {
    position: relative;
    width: 100%;
    height: 8px;
    background: #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
}

.progress-bar {
    position: absolute;
    height: 100%;
    width: 40%;
    background: linear-gradient(90deg, #4caf50, #81c784);
    border-radius: 4px;
    animation: indeterminate 1.2s infinite ease-in-out;
}

@keyframes indeterminate {
    0% { left: -40%; }
    50% { left: 100%; }
    100% { left: -40%; }
}
</style>
<style>
  /* Modal overlay */
  #modal_view {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    display: none; /* Ẩn mặc định */
    z-index: 9999;
    overflow-y: auto; /* Scroll nếu nội dung dài */
  }

  /* Nội dung modal */
  #modal_body {
    background: #fff;
    min-height: 100%;
    width: 100%;
    box-sizing: border-box;
    padding: 60px 20px 20px; /* Xích nội dung để tránh đè nút close */
  }

  /* Nút đóng */
  #btn_close_modal {
    position: fixed;
    top: 10px;
    right: 10px;
    background: transparent;
    border: none;
    font-size: 22px;
    padding: 6px;
    cursor: pointer;
  }
  #btn_close_modal:hover {
    background: rgba(0,0,0,0.1);
    border-radius: 6px;
  }
</style>
<b>Email external (nếu không vui lòng để trống) : </b>
<br />
<input type="text" id="indexAnotherLoginMail" style="width: 5px;" autocomplete="off" />
<br />
<b>Nhập email : </b>
<br />
<input type="text" id="mail" style="width: 600px;" autocomplete="off" />
<br />
<b>Nhập subject : </b>
<br />
<input type="text" id="subject" style="width: 600px;" autocomplete="off" />
<br />
<b>Nhập nội dung : </b>
<br />
<textarea id="message" cols="200" rows="20" autocomplete="off"></textarea>
<br />
<input id="isHTML" type="checkbox" autocomplete="off" /><b style="color:blue">Is body mail HTML</b>&nbsp;&nbsp;&nbsp;&nbsp;<button onclick="showModalView()" style="color:deeppink;"><b>Xem trước HTML</b></button>
<br />
<input type="file" id="files" multiple /><input type="checkbox" id="sendFile" /><b style="color:darkgreen">Upload file lên server MegaIO</b>
<br /><br />
<button onclick="sendmail()"><b style="color:red">SEND MAIL</b></button>
<div id="modal_view">
  <button id="btn_close_modal" onclick="closeModalView()">❌</button>
  <div id="modal_body">
    <div id="modal_data"></div>
  </div>
</div>
<!-- Processing Modal -->
<div id="processingOverlay" class="processing-overlay">
    <div class="processing-modal">
        <div class="processing-title">Đang xử lý</div>
        <div class="progress-container">
            <div class="progress-bar"></div>
        </div>
    </div>
</div>
<script>
  function showModalView() {
    // Gán nội dung trước
    document.getElementById("modal_data").innerHTML =
        document.getElementById("message").value;

    // Rồi mới bật modal
    document.getElementById("modal_view").style.display = "block";
  }

  function closeModalView() {
    document.getElementById("modal_view").style.display = "none";
  }
</script>
<script>
    var loaded = 0;
    setTimeout(() => {
       if (loaded == 2) return;
       const sub = localStorage.getItem("data_subject");
      const msg = localStorage.getItem("data_message");
      const html = localStorage.getItem("data_isHTML");
      if (sub !== null) document.getElementById("subject").value = sub;
      if (msg !== null) document.getElementById("message").value = msg;
      if (html === "true") document.getElementById("isHTML").checked = true;
       loaded++;
       if (loaded == 2)
       {
        localStorage.removeItem("data_subject");
        localStorage.removeItem("data_message");
        localStorage.removeItem("data_isHTML");
       }
    }, 1000);

async function sendmail()
{
showProcessingModal();
var mail = document.getElementById("mail").value;
var subject = document.getElementById("subject").value;
var message = document.getElementById("message").value;
var indexAnotherLoginMail = document.getElementById("indexAnotherLoginMail").value;
var isHTML = document.getElementById("isHTML").checked;
localStorage.removeItem("data_subject");
localStorage.removeItem("data_message");
localStorage.removeItem("data_isHTML");

var input = document.getElementById('files');
var files = input.files;

var formData = new FormData();
formData.append("txtEmail", mail);
formData.append("txtMessage", message);
formData.append("txtSubject", subject);
formData.append("isBodyHTML", "" + isHTML);
formData.append("indexAnotherLoginMail", "" + indexAnotherLoginMail);

for (var i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
}

fetch("/Home/SendMailSave1?isUploadFileMegaIO=" + (document.getElementById("sendFile").checked ? "true" : "false"), {
method: "POST",
body: formData
})
.then(res => res.json())
.then(data => {
if (data.result == true)
{
closeProcessingModal();
alert("Tiến trình gửi e-mail hiện đang được xử lý!");
}
});
}
</script>
<script>
let processingModalVisible = false;

function showProcessingModal() {
    if (processingModalVisible) return;

    const overlay = document.getElementById("processingOverlay");
    overlay.classList.add("active");

    document.body.style.overflow = "hidden";       // chặn scroll
    document.body.style.pointerEvents = "none";   // chặn toàn bộ click phía sau
    overlay.style.pointerEvents = "auto";         // nhưng vẫn cho modal hoạt động

    processingModalVisible = true;
}

function closeProcessingModal() {
    if (!processingModalVisible) return;

    const overlay = document.getElementById("processingOverlay");
    overlay.classList.remove("active");

    document.body.style.overflow = "";
    document.body.style.pointerEvents = "";

    processingModalVisible = false;
}

/* Chặn ESC */
document.addEventListener("keydown", function (e) {
    if (processingModalVisible && e.key === "Escape") {
        e.preventDefault();
        e.stopPropagation();
    }
});
</script>
